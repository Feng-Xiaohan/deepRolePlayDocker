# ====================================================================
# DeepRolePlay 配置文件详细说明 - 初学者指南
# ====================================================================

## 🤔 什么是"转发LLM"和"Agent LLM"？

【转发LLM】= 你实际想要聊天的AI模型
• 这是最终与用户聊天的AI，比如DeepSeek、Claude、GPT等
• 你在SillyTavern中填入的API密钥就是这个模型的
• 配置位置：下方proxy部分

【Agent LLM】= 幕后智能助手AI模型  
• 负责"记忆闪回"和"情景更新"，用户看不到它的回复
• 推荐使用Gemini 2.5 Flash（响应速度快）
• 配置位置：下方agent部分

💡 举例：
- 转发LLM：DeepSeek（便宜，与用户聊天）→ 在proxy部分填入base_url，在前端填入api_key等配置。前端应填入base_url为http://localhost:6666/api/v1
- Agent LLM：Gemini 2.5 Flash（后台工作）→ 在agent部分填入
- 你需要两个不同的API密钥！

🔗 数据流：用户 → DeepRolePlay → Agent LLM处理记忆 → 转发LLM生成回复

# ====================================================================
# 配置项详细说明
# ====================================================================

## 【API代理配置】转发到目标LLM服务

### target_url
- 说明：最终LLM服务地址
- 作用：控制请求转发目标
- 修改建议：需要修改，填入你的LLM服务API地址

### api_key
- 说明：API密钥
- 作用：转发给目标LLM服务的API密钥
- 修改建议：需要修改，填入你的目标服务API密钥，将覆盖请求头中的密钥

### provider
- 说明：服务提供商
- 作用：可选，指定OpenRouter等聚合服务的具体提供商
- 示例：「novita/fp8」、「deepinfra/fp8」

### timeout
- 说明：HTTP请求超时（秒）
- 作用：控制请求等待时间
- 修改建议：通常无需修改，30秒足够

### debug_mode
- 说明：调试模式开关
- 作用：控制是否跳过工作流直接返回测试消息
- 修改建议：通常无需修改，正常运行时为false

### save_full_messages
- 说明：保存完整消息开关
- 作用：控制是否保存完整的请求消息
- 修改建议：通常无需修改，false节省tokens，true用于调试

## 【情景文件配置】角色状态存储

### file_path
- 说明：情景文件存储路径
- 作用：控制角色状态保存位置
- 修改建议：通常无需修改，自动创建目录

### output_format
- 说明：表格输出格式
- 作用：控制表格数据输出格式
- 修改建议：可调整，「table」为格式化文本，「json」为JSON字符串

### clear_strategy
- 说明：重复消息清理策略
- 作用：控制何时清理重复消息
- 选项：「auto」（自动检测）、「always」（总是清理）、「manual」（手动清理）
- 修改建议：通常使用「auto」，自动检测到相似消息时清理, 效果是切卡时不再需要手动删除旧情景了

### similarity_threshold
- 说明：消息相似度阈值
- 作用：判断消息是否重复的相似度标准
- 范围：0.0-1.0（0.9表示90%相似度）
- 修改建议：通常无需修改，0.9对大多数场景合理

## 【工作流控制配置】Agent执行参数

### max_history_length
- 说明：传递给目标LLM的历史消息数量
- 作用：控制上下文长度和token消耗
- 修改建议：可调整，3-15条消息，影响记忆效果和成本

### last_ai_messages_index
- 说明：最后AI消息索引
- 作用：根据你预设不同选择使用哪条AI消息作为真实回复
- 修改建议：通常无需修改，1表示最后一条AI消息，-1表示自动查找第一个内容长度>ai_message_min_length的AI消息的倒数索引

### ai_message_min_length
- 说明：AI消息最小长度阈值
- 作用：当last_ai_messages_index=-1时用于自动查找AI消息
- 修改建议：可调整，50-200，影响自动查找的准确性

### only_forward
- 说明：快速转发模式
- 作用：控制是否跳过Agent直接转发
- 修改建议：通常无需修改，正常运行时为false

### stream_workflow_to_frontend
- 说明：工作流前端流式开关
- 作用：控制是否将agent推理过程推送到前端
- 修改建议：可调整，true显示推理过程，false只显示最终对话

## 【Agent配置】用于记忆闪回和情景更新的AI模型

### model
- 说明：AI模型名称
- 作用：控制使用哪个AI模型
- 修改建议：使用Qwen3作为agent模型

### temperature
- 说明：生成随机性（0-1）
- 作用：控制回答创造性
- 修改建议：可调整，0.1稳定，0.7有创意，影响一致性

### base_url
- 说明：API服务提供商地址
- 作用：控制模型调用接口
- 修改建议：使用OpenRouter API

### api_key
- 说明：API访问密钥
- 作用：控制服务认证
- 修改建议：需要修改，填入你的OpenRouter API密钥

### provider
- 说明：服务提供商
- 作用：可选，指定OpenRouter等聚合服务的具体提供商
- 示例：「novita/fp8」、「deepinfra/fp8」

### max_tokens
- 说明：最大输出tokens
- 作用：控制单次生成长度限制
- 修改建议：通常无需修改，8192足够应对大多数情景

### top_p
- 说明：采样概率阈值（0-1）
- 作用：控制词汇选择范围
- 修改建议：通常无需修改，0.9确保多样性

### debug
- 说明：Agent调试信息
- 作用：控制是否显示详细执行过程
- 修改建议：调试时修改，true显示过程，false正常运行

### max_iterations
- 说明：最大执行轮数
- 作用：控制上限防止无限循环
- 修改建议：通常无需修改，40轮足够应对复杂任务

### stream_mode
- 说明：Agent工作流流式模式
- 作用：控制Agent执行时是否使用真流式
- 修改建议：通常无需修改，true为真流式（astream），false为伪流式（ainvoke），需要破限时才改成false

### workflow_mode
- 说明：工作流执行模式
- 作用：控制使用哪种工作流配置
- 选项：「fast」（经济快速模式）、「i_am_rich」（高性能模式）
- 修改建议：通常使用「fast」，成本控制更好

### timeout
- 说明：单次请求超时（秒）
- 作用：控制Agent调用等待时间
- 修改建议：可调整，网络慢时可增加到180

## 【服务器配置】DeepRolePlay服务网络设置

### host
- 说明：监听IP地址
- 作用：控制外部访问权限
- 修改建议：通常无需修改，0.0.0.0允许局域网访问

### port
- 说明：服务端口号
- 作用：控制前端连接端口
- 修改建议：可调整，如被占用会自动+1，前端需相应修改

### reload
- 说明：代码热重载
- 作用：控制开发时自动重启
- 修改建议：通常无需修改，生产环境false避免意外重启

## 【ComfyUI配置】图片生成服务

### enabled
- 说明：使能开关
- 作用：控制图片生成功能是否启用

### ip
- 说明：ComfyUI服务器IP地址
- 作用：连接到ComfyUI服务

### port
- 说明：ComfyUI服务器端口
- 作用：指定ComfyUI服务端口

### api_key
- 说明：ComfyUI API密钥
- 作用：ComfyUI服务认证

### workflow_path
- 说明：ComfyUI工作流文件路径
- 作用：指定图片生成工作流配置

### positive_prompt_node_id
- 说明：正向提示词节点ID
- 作用：ComfyUI工作流中正向提示词节点的ID

### latent_image_node_id
- 说明：潜在图像节点ID
- 作用：ComfyUI工作流中图像生成节点的ID

### width
- 说明：生成图片宽度
- 作用：控制输出图片的像素宽度

### height
- 说明：生成图片高度
- 作用：控制输出图片的像素高度

### num_images
- 说明：每次生成图片数量
- 作用：控制单次请求生成的图片数量

### positive_prefix
- 说明：正向提示词前缀
- 作用：自动添加到所有图片生成提示词前的固定前缀

### max_display_size
- 说明：前端显示图片的最大边长（像素）
- 作用：控制传输给SillyTavern的图片尺寸，影响传输速度和显示效果